{"version":3,"file":"cli.js","sources":["../src/logger.ts","../src/require.ts","../src/index.ts","../src/cli.ts"],"sourcesContent":["class Logger {\n\tlog(format: string, ...params: string[]) {\n\t\tconsole.log(format, ...params);\n\t}\n}\n\nexport default Logger;\n","import { createRequire } from 'module';\nimport { fileURLToPath } from 'url';\n\nconst require = createRequire(fileURLToPath(import.meta.url));\n\nexport default require;\n","import { createRequire } from 'node:module';\nimport path from 'node:path';\nimport { fileURLToPath, pathToFileURL } from 'node:url';\nimport fg from 'fast-glob';\nimport fs from 'node:fs';\nimport { build, loadConfigFromFile, UserConfig } from 'vite';\nimport Logger from './logger';\nimport require from './require';\n\nfunction importJSON(filePath: string) {\n\treturn require(filePath);\n}\n\nfunction importPackageJSON(filePath: string) {\n\treturn importJSON(path.resolve(filePath, './package.json'));\n}\n\ninterface ViteMonoConfig {\n\troot: string;\n}\n\nasync function workspaceEntries(\n\troot: string,\n\tpackageObject: Record<string, unknown>,\n): Promise<[string, string][]> {\n\tif (!packageObject.workspaces) {\n\t\treturn [];\n\t}\n\n\t// resolve all these workspaces to actual paths.\n\tconst workspaces = await fg(packageObject.workspaces as string | string[], {\n\t\tcwd: root,\n\t\tonlyDirectories: true,\n\t\tabsolute: true,\n\t});\n\n\tconst aliasEntries = await Promise.all(\n\t\tworkspaces.map(async (workspacePath: string) => {\n\t\t\tconst workspacePackageFile = path.resolve(workspacePath, 'package.json');\n\t\t\tconst workspacePackageObject = await importJSON(workspacePackageFile);\n\n\t\t\t// return the workspace root (not the src folder) so we can locate vite configs\n\t\t\treturn [workspacePackageObject.name, workspacePath] as [string, string];\n\t\t}),\n\t);\n\n\treturn aliasEntries;\n}\n\nconst globFiles = (root: string, pattern: string | string[]) =>\n\tfg(pattern, {\n\t\tcwd: root,\n\t\tonlyFiles: true,\n\t\tbraceExpansion: true,\n\t\tglobstar: true,\n\t\tabsolute: true,\n\t});\n\nconst globFile = (...args: Parameters<typeof globFiles>) =>\n\tglobFiles(...args).then((entries) => entries[0] ?? null);\n\nconst messages = {\n\t'config-not-found':\n\t\t\"A Vite Config is required for workspace '%s' to be built. skipping workspace '%s' due to missing configuration...\",\n\t'config-resolution-error': \"An error occured while resolving a configuration for workspace '%s'.\",\n\t'source-resolution-error': \"Cannot resolve the source directory for '%s'.\",\n};\n\nconst logger = new Logger();\n\ntype WorkspaceEntry = [string, string];\n\ninterface Workspace {\n\tconfig: UserConfig;\n\tconfigFile: string;\n\tworkspaceBindingAliases: Record<string, string>;\n\tsource: string;\n\troot: string;\n}\n\nclass ViteMono {\n\tpublic root: string;\n\tpublic package: Promise<Record<string, string | string[]>>;\n\n\tconstructor(options: ViteMonoConfig) {\n\t\tconst root = path.resolve(process.cwd(), options.root);\n\t\tthis.root = root;\n\t\tthis.package = importPackageJSON(root);\n\t}\n\n\tasync getAllWorkspaceEntries() {\n\t\treturn workspaceEntries(this.root, await this.package);\n\t}\n\n\tasync getBuildConfiguration(\n\t\tworkspaceName: string,\n\t\tworkspaceAbsolutePath: string,\n\t): Promise<NonNullable<Awaited<ReturnType<typeof loadConfigFromFile>>> | null> {\n\t\tconst viteConfigPath = await globFile(\n\t\t\tworkspaceAbsolutePath,\n\t\t\t'vite.config.{cjs,mjs,js,cts,mts,ts}',\n\t\t);\n\n\t\tconsole.log(viteConfigPath);\n\n\t\tif (!viteConfigPath) {\n\t\t\tlogger.log(messages['config-not-found'], workspaceName, workspaceName);\n\t\t\treturn null;\n\t\t}\n\n\t\tconst configResolutionResult = await loadConfigFromFile(\n\t\t\t{\n\t\t\t\tcommand: 'build',\n\t\t\t\tmode: 'production',\n\t\t\t},\n\t\t\tviteConfigPath,\n\t\t\tworkspaceAbsolutePath,\n\t\t\t'silent',\n\t\t\tundefined,\n\t\t\t'runner',\n\t\t);\n\n\t\tif (!configResolutionResult) {\n\t\t\tlogger.log(messages['config-resolution-error'], workspaceName);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn configResolutionResult;\n\t}\n\n\tasync getSourceDirectory(workspaceName: string, workspacePath: string) {\n\t\tlet source: string | null = null;\n\t\ttry {\n\t\t\tconst pkg = await importJSON(path.resolve(workspacePath, 'package.json'));\n\t\t\tif (pkg && typeof pkg.source === 'string' && pkg.source.length > 0) {\n\t\t\t\tsource = pkg.source;\n\t\t\t}\n\t\t} catch {\n\t\t\t// ignore package read errors and fallback to scanning dirs\n\t\t}\n\n\t\t// also test if source exists.\n\t\t// otherwise, fall on through popular\n\t\t// source directory names.\n\t\tconst popularNames = ['src', 'source', 'lib', 'lib/src'];\n\t\tconst candidates = source ? [source, ...popularNames] : popularNames;\n\t\tfor (const cand of candidates) {\n\t\t\tconst candPath = path.resolve(workspacePath, cand);\n\t\t\tif (fs.existsSync(candPath) && fs.statSync(candPath).isDirectory()) {\n\t\t\t\tsource = cand;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (!source) {\n\t\t\tlogger.log(messages['source-resolution-error'], workspaceName);\n\t\t\treturn null;\n\t\t}\n\n\t\treturn source;\n\t}\n\n\tasync getAllWorkspaces(workspaceEntries: WorkspaceEntry[]): Promise<Workspace[]> {\n\t\tconst workspaceMap = Object.fromEntries(workspaceEntries);\n\t\tconst workspaces: (Workspace | null)[] = await Promise.all(\n\t\t\tworkspaceEntries.map(async ([workspaceName, workspacePath]) => {\n\t\t\t\tconst workspaceBindingAliases = { ...workspaceMap };\n\n\t\t\t\t// remove the current workspace package itself.\n\t\t\t\tdelete workspaceBindingAliases[workspaceName];\n\n\t\t\t\tconst configResolutionResult = await this.getBuildConfiguration(\n\t\t\t\t\tworkspaceName,\n\t\t\t\t\tworkspacePath,\n\t\t\t\t);\n\n\t\t\t\tif (!configResolutionResult) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\tconst { config, path: viteConfigPath } = configResolutionResult;\n\n\t\t\t\tconst source = await this.getSourceDirectory(workspaceName, workspacePath);\n\n\t\t\t\tif (!source) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tconfig,\n\t\t\t\t\tworkspaceBindingAliases,\n\t\t\t\t\tsource,\n\t\t\t\t\troot: workspacePath,\n\t\t\t\t\tconfigFile: viteConfigPath,\n\t\t\t\t};\n\t\t\t}),\n\t\t);\n\n\t\t// could have used Boolean but typescript is not\n\t\t// happy with that.\n\t\treturn workspaces.filter((w) => w !== null);\n\t}\n\n\tasync build() {\n\t\tconst workspaceEntries = await this.getAllWorkspaceEntries();\n\n\t\t// a set to track workspaces.\n\t\t// prepare alias map for workspace packages so builds can resolve local packages to their src\n\t\tconst workspaces = await this.getAllWorkspaces(workspaceEntries);\n\n\t\tfor (const workspace of workspaces) {\n\t\t\tconst mergedResolve = {\n\t\t\t\t...(workspace.config.resolve ?? {}),\n\t\t\t\talias: {\n\t\t\t\t\t...(workspace.config.resolve?.alias ?? {}),\n\t\t\t\t\t...workspace.workspaceBindingAliases,\n\t\t\t\t},\n\t\t\t};\n\n\t\t\tawait build({\n\t\t\t\t...workspace.config,\n\t\t\t\troot: workspace.root,\n\t\t\t\tresolve: mergedResolve,\n\t\t\t\tforceOptimizeDeps: true,\n\t\t\t\tconfigFile: workspace.configFile,\n\t\t\t\tlogLevel: 'silent',\n\t\t\t});\n\t\t}\n\t}\n}\n\nexport { ViteMono };\nexport type { ViteMonoConfig };\n","import yargs from 'yargs';\nimport { hideBin } from 'yargs/helpers';\nimport { ViteMono, ViteMonoConfig } from '.';\nimport require from './require';\nimport path from 'node:path';\nimport { pathToFileURL } from 'node:url';\n\nasync function bootstrap() {\n\tconst args = await yargs(hideBin(process.argv))\n\t\t.option('config', {\n\t\t\talias: 'c',\n\t\t\ttype: 'string',\n\t\t\tdefault: 'vite-mono.config.js',\n\t\t\tdescription: 'Path to config file',\n\t\t})\n\t\t.parseAsync();\n\n\t// current working directory\n\tconst cwd = process.cwd();\n\n\t// ensure config path is a string\n\tconst configPath = args.config || 'vite-mono.config.js';\n\n\t// vite mono config path\n\tconst vmConfigPath = path.resolve(cwd, configPath);\n\n\t// load config - support both CommonJS (require) and ESM (dynamic import)\n\tlet vmConfig: ViteMonoConfig | undefined;\n\ttry {\n\t\t// attempt to require (works for CJS and some transpiled modules)\n\t\tconst loaded = require(vmConfigPath);\n\t\tvmConfig = loaded && loaded.__esModule && loaded.default ? loaded.default : loaded;\n\t} catch {\n\t\t// fallback to dynamic import for ESM configs\n\t\tconst fileUrl = pathToFileURL(vmConfigPath).href;\n\t\tconst imported = await import(fileUrl);\n\t\tvmConfig = imported.default ?? imported;\n\t}\n\n\tif (!vmConfig || typeof vmConfig.root !== 'string') {\n\t\tthrow new TypeError(\n\t\t\t`Invalid ViteMono config loaded from ${vmConfigPath}. Expected an object with a string 'root' property.`,\n\t\t);\n\t}\n\n\tconst vm = new ViteMono(vmConfig as ViteMonoConfig);\n\n\t// build\n\tawait vm.build();\n}\n\nbootstrap().catch(console.error);\n"],"names":["require","workspaceEntries"],"mappings":"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"}